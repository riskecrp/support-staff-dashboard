/**
 * DemoteSupport.gs
 *
 * Shows a modal dialog with a server-populated dropdown of alphabetized unique names
 * from SSRoster (column A). When the user selects a name and clicks "Demote", the script
 * sets column C ("SeniorSupport") for that row to FALSE and appends a log row to SupportChangesLog.
 *
 * No "promote another?" confirm â€” the dialog closes after the action.
 *
 * Usage:
 * - Add this file to your Apps Script project, save and reload the spreadsheet,
 *   then choose Support Management -> Demote Support.
 */

function demoteSupport() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var names = _getSSRosterNames(); // server-side fetch & sort & dedupe

  // Build options HTML safely
  var optionsHtml = '';
  if (names.length === 0) {
    optionsHtml = '<option value="">No names available</option>';
  } else {
    for (var i = 0; i < names.length; i++) {
      optionsHtml += '<option value="' + _escapeHtml(names[i]) + '">' + _escapeHtml(names[i]) + '</option>';
    }
  }

  var html =
    '<!DOCTYPE html><html><head><base target="_top"></head><body>' +
    '<div style="font-family: Arial, sans-serif; padding:12px; max-width:520px;">' +
    '<label for="nameSelect"><strong>Select name to demote from Senior Support:</strong></label><br/>' +
    '<select id="nameSelect" style="width:100%; margin-top:8px;">' +
    optionsHtml +
    '</select>' +
    '<div style="margin-top:12px; text-align:right;">' +
    '<button id="cancelBtn">Cancel</button> ' +
    '<button id="demoteBtn">Demote</button>' +
    '</div>' +
    '<div id="status" style="margin-top:12px; color:#333; white-space:pre-wrap;"></div>' +
    '</div>' +
    '<script>' +
    '  document.getElementById("cancelBtn").onclick = function(){ google.script.host.close(); };' +
    '  document.getElementById("demoteBtn").onclick = function(){' +
    '    var sel = document.getElementById("nameSelect").value; if(!sel){ alert("Please select a name."); return; }' +
    '    this.disabled = true; document.getElementById("status").textContent = "Demoting " + sel + "...";' +
    '    google.script.run.withSuccessHandler(function(msg){ alert(msg); google.script.host.close(); }).withFailureHandler(function(err){ alert("Error demoting: " + err.message); document.getElementById("demoteBtn").disabled = false; document.getElementById("status").textContent = ""; }).demoteSupportByName(sel);' +
    '  };' +
    '</script>' +
    '</body></html>';

  var htmlOutput = HtmlService.createHtmlOutput(html).setWidth(520).setHeight(220);
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'Demote Support');
}

/* Server-side helper: read SSRoster column A (rows 2..lastRow), dedupe case-insensitive and sort */
function _getSSRosterNames() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('SSRoster');
  if (!sheet) {
    // fallback: case-insensitive match for sheet name
    var sheets = ss.getSheets();
    for (var i = 0; i < sheets.length; i++) {
      var n = sheets[i].getName();
      if (n && n.toLowerCase().replace(/\s+/g,'') === 'ssroster') {
        sheet = sheets[i];
        break;
      }
    }
  }
  if (!sheet) return [];

  var lastRow = sheet.getLastRow();
  if (lastRow < 2) return [];

  var vals = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
  var names = [];
  for (var j = 0; j < vals.length; j++) {
    var n = String(vals[j][0] || '').trim();
    if (n) names.push(n);
  }
  if (names.length === 0) return [];

  // sort and dedupe (case-insensitive), keep first-case occurrence
  names.sort(function(a,b){ return a.toLowerCase().localeCompare(b.toLowerCase()); });
  var seen = {};
  var unique = [];
  for (var k = 0; k < names.length; k++) {
    var key = names[k].toLowerCase();
    if (!seen[key]) { seen[key] = true; unique.push(names[k]); }
  }
  return unique;
}

/* Demote action: set column C to FALSE for the row matching name (case-insensitive) and log */
function demoteSupportByName(name) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('SSRoster');
  if (!sheet) {
    // fallback: case-insensitive sheet name match
    var sheets = ss.getSheets();
    for (var i = 0; i < sheets.length; i++) {
      var n = sheets[i].getName();
      if (n && n.toLowerCase().replace(/\s+/g,'') === 'ssroster') { sheet = sheets[i]; break; }
    }
  }
  if (!sheet) return 'SSRoster sheet not found.';

  var lastRow = sheet.getLastRow();
  if (lastRow < 2) return 'No names in SSRoster.';

  var namesVals = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
  var foundRow = -1;
  for (var i = 0; i < namesVals.length; i++) {
    var existing = String(namesVals[i][0] || '').trim();
    if (existing && existing.toLowerCase() === name.toLowerCase()) {
      foundRow = i + 2;
      break;
    }
  }
  if (foundRow === -1) return 'Name "' + name + '" not found in SSRoster.';

  var priorSenior = sheet.getRange(foundRow, 3).getValue();
  sheet.getRange(foundRow, 3).setValue(false);

  // Append to SupportChangesLog (non-fatal on failure)
  try {
    var logSheet = ss.getSheetByName('SupportChangesLog');
    if (!logSheet) {
      logSheet = ss.insertSheet('SupportChangesLog');
      logSheet.appendRow(['Timestamp', 'Name', 'Action', 'PriorSenior', 'NewSenior']);
    }
    var row = [
      new Date().toISOString(),
      name,
      'Demoted from SeniorSupport (SeniorSupport=FALSE)',
      (priorSenior === true ? 'TRUE' : (priorSenior === false ? 'FALSE' : String(priorSenior))),
      'FALSE'
    ];
    logSheet.getRange(logSheet.getLastRow() + 1, 1, 1, row.length).setValues([row]);
  } catch (e) {
    // ignore logging failure
  }

  return 'SeniorSupport set to FALSE for "' + name + '".';
}

/* small utility to escape HTML when building option text */
function _escapeHtml(text) {
  if (text === null || text === undefined) return '';
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
